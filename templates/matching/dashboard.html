{% extends 'base.html' %}
{% load static %}

{% block title %}Matching Dashboard - ReferWell Direct{% endblock %}

{% block extra_css %}
<style>
    .nhsuk-card--clickable {
        cursor: pointer;
        transition: box-shadow 0.2s ease-in-out;
    }
    .nhsuk-card--clickable:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    .stat-card {
        background: #f0f4f5;
        border-left: 4px solid #005eb8;
        padding: 1rem;
        border-radius: 4px;
    }
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #005eb8;
        margin: 0;
    }
    .stat-label {
        font-size: 0.875rem;
        color: #425563;
        margin: 0.25rem 0 0 0;
    }
    .queue-item {
        border: 1px solid #d8e2e3;
        border-radius: 4px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: white;
    }
    .queue-item--high-touch {
        border-left: 4px solid #d5281b;
    }
    .queue-item--auto {
        border-left: 4px solid #00a499;
    }
    .queue-item--manual {
        border-left: 4px solid #f9b000;
    }
    .priority-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: bold;
        text-transform: uppercase;
    }
    .priority-badge--urgent {
        background-color: #d5281b;
        color: white;
    }
    .priority-badge--high {
        background-color: #f9b000;
        color: #212b32;
    }
    .priority-badge--medium {
        background-color: #00a499;
        color: white;
    }
    .priority-badge--low {
        background-color: #425563;
        color: white;
    }
    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: bold;
        text-transform: uppercase;
    }
    .status-badge--high-touch {
        background-color: #d5281b;
        color: white;
    }
    .status-badge--shortlisted {
        background-color: #00a499;
        color: white;
    }
    .status-badge--matching {
        background-color: #f9b000;
        color: #212b32;
    }
    .status-badge--submitted {
        background-color: #425563;
        color: white;
    }
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    .nhsuk-button--small {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #425563;
    }
    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    .filter-controls {
        background: #f0f4f5;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 2rem;
    }
    .filter-row {
        display: flex;
        gap: 1rem;
        align-items: end;
        flex-wrap: wrap;
    }
    .filter-group {
        flex: 1;
        min-width: 200px;
    }
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        .filter-row {
            flex-direction: column;
            align-items: stretch;
        }
        .filter-group {
            min-width: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">
        <h1 class="nhsuk-heading-xl">Matching Dashboard</h1>
        <p class="nhsuk-body-l">Monitor and manage referral matching across the system.</p>
        
        <!-- Screen reader announcement for dynamic content -->
        <div class="nhsuk-u-visually-hidden" aria-live="polite" id="status-announcements"></div>
    </div>
</div>

<!-- Statistics Overview -->
<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">
        <h2 class="nhsuk-heading-l">System Overview</h2>
        <div class="stats-grid" role="region" aria-label="System statistics">
            <div class="stat-card" role="group" aria-labelledby="total-referrals-label">
                <p class="stat-number" id="total-referrals" aria-label="{{ total_referrals|default:0 }} total referrals">{{ total_referrals|default:0 }}</p>
                <p class="stat-label" id="total-referrals-label">Total Referrals</p>
            </div>
            <div class="stat-card" role="group" aria-labelledby="auto-routed-label">
                <p class="stat-number" id="auto-routed" aria-label="{{ auto_routed|default:0 }} auto-routed referrals">{{ auto_routed|default:0 }}</p>
                <p class="stat-label" id="auto-routed-label">Auto-Routed</p>
            </div>
            <div class="stat-card" role="group" aria-labelledby="high-touch-queue-label">
                <p class="stat-number" id="high-touch-queue" aria-label="{{ high_touch_queue|default:0 }} referrals in high-touch queue">{{ high_touch_queue|default:0 }}</p>
                <p class="stat-label" id="high-touch-queue-label">High-Touch Queue</p>
            </div>
            <div class="stat-card" role="group" aria-labelledby="manual-review-label">
                <p class="stat-number" id="manual-review" aria-label="{{ manual_review|default:0 }} referrals requiring manual review">{{ manual_review|default:0 }}</p>
                <p class="stat-label" id="manual-review-label">Manual Review</p>
            </div>
        </div>
    </div>
</div>

<!-- Filter Controls -->
<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">
        <div class="filter-controls" role="region" aria-labelledby="filter-heading">
            <h3 class="nhsuk-heading-m" id="filter-heading">Filter Referrals</h3>
            <form method="get" class="filter-row" role="search" aria-label="Filter referrals">
                <div class="filter-group">
                    <label class="nhsuk-label" for="status-filter">Status</label>
                    <select class="nhsuk-select" id="status-filter" name="status" aria-describedby="status-help">
                        <option value="">All Statuses</option>
                        <option value="submitted">Submitted</option>
                        <option value="matching">Matching</option>
                        <option value="high_touch_queue">High-Touch Queue</option>
                        <option value="shortlisted">Shortlisted</option>
                    </select>
                    <div class="nhsuk-hint" id="status-help">Filter referrals by their current status</div>
                </div>
                <div class="filter-group">
                    <label class="nhsuk-label" for="priority-filter">Priority</label>
                    <select class="nhsuk-select" id="priority-filter" name="priority" aria-describedby="priority-help">
                        <option value="">All Priorities</option>
                        <option value="urgent">Urgent</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                    <div class="nhsuk-hint" id="priority-help">Filter referrals by priority level</div>
                </div>
                <div class="filter-group">
                    <label class="nhsuk-label" for="service-type-filter">Service Type</label>
                    <select class="nhsuk-select" id="service-type-filter" name="service_type" aria-describedby="service-type-help">
                        <option value="">All Service Types</option>
                        <option value="nhs">NHS</option>
                        <option value="private">Private</option>
                        <option value="mixed">Mixed</option>
                    </select>
                    <div class="nhsuk-hint" id="service-type-help">Filter referrals by service type</div>
                </div>
                <div class="filter-group">
                    <button class="nhsuk-button" type="submit" aria-describedby="apply-help">Apply Filters</button>
                    <a href="{% url 'matching:dashboard' %}" class="nhsuk-button nhsuk-button--secondary" aria-describedby="clear-help">Clear</a>
                    <div class="nhsuk-hint" id="apply-help">Apply the selected filters to the referral list</div>
                    <div class="nhsuk-hint" id="clear-help">Clear all filters and show all referrals</div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Referral Queues -->
<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">
        <h2 class="nhsuk-heading-l">Referral Queues</h2>
        
        <!-- High-Touch Queue -->
        <div class="nhsuk-card">
            <div class="nhsuk-card__content">
                <h3 class="nhsuk-card__heading" id="high-touch-queue-heading">High-Touch Queue</h3>
                <p class="nhsuk-card__description">Referrals requiring manual review and expert matching.</p>
                
                <div id="high-touch-queue-list" role="region" aria-labelledby="high-touch-queue-heading" aria-live="polite">
                    {% if high_touch_referrals %}
                        {% for referral in high_touch_referrals %}
                        <div class="queue-item queue-item--high-touch" role="article" aria-labelledby="referral-{{ referral.id }}-title">
                            <div class="nhsuk-grid-row">
                                <div class="nhsuk-grid-column-two-thirds">
                                    <h4 class="nhsuk-heading-s" id="referral-{{ referral.id }}-title">
                                        <a href="{% url 'referrals:detail' referral.id %}" class="nhsuk-link" 
                                           aria-describedby="referral-{{ referral.id }}-description">
                                            {{ referral.referral_id }}
                                        </a>
                                    </h4>
                                    <p class="nhsuk-body-s" id="referral-{{ referral.id }}-description">
                                        {{ referral.presenting_problem|truncatechars:100 }}
                                    </p>
                                    <p class="nhsuk-body-xs" id="referral-{{ referral.id }}-details">
                                        <strong>Patient:</strong> {{ referral.patient.get_full_name }} |
                                        <strong>Referrer:</strong> {{ referral.referrer.get_full_name }} |
                                        <strong>Created:</strong> {{ referral.created_at|date:"d M Y H:i" }}
                                    </p>
                                </div>
                                <div class="nhsuk-grid-column-one-third">
                                    <div class="action-buttons" role="group" aria-label="Referral status indicators">
                                        <span class="priority-badge priority-badge--{{ referral.priority }}" 
                                              aria-label="Priority: {{ referral.get_priority_display }}">
                                            {{ referral.get_priority_display }}
                                        </span>
                                        <span class="status-badge status-badge--high-touch" 
                                              aria-label="Status: High-Touch queue">
                                            High-Touch
                                        </span>
                                    </div>
                                    <div class="action-buttons" role="group" aria-label="Referral actions">
                                        <a href="{% url 'matching:find_matches' referral.id %}" 
                                           class="nhsuk-button nhsuk-button--small"
                                           aria-describedby="find-matches-help-{{ referral.id }}">
                                            Find Matches
                                        </a>
                                        <a href="{% url 'referrals:detail' referral.id %}" 
                                           class="nhsuk-button nhsuk-button--secondary nhsuk-button--small"
                                           aria-describedby="view-details-help-{{ referral.id }}">
                                            View Details
                                        </a>
                                        <div class="nhsuk-u-visually-hidden" id="find-matches-help-{{ referral.id }}">
                                            Find matching psychologists for referral {{ referral.referral_id }}
                                        </div>
                                        <div class="nhsuk-u-visually-hidden" id="view-details-help-{{ referral.id }}">
                                            View full details for referral {{ referral.referral_id }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <p class="nhsuk-body-l">No referrals in high-touch queue</p>
                            <p class="nhsuk-body">Referrals requiring manual review will appear here.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Auto-Routed Referrals -->
        <div class="nhsuk-card">
            <div class="nhsuk-card__content">
                <h3 class="nhsuk-card__heading" id="auto-routed-heading">Auto-Routed Referrals</h3>
                <p class="nhsuk-card__description">Referrals automatically matched with high confidence scores.</p>
                
                <div id="auto-routed-list" role="region" aria-labelledby="auto-routed-heading" aria-live="polite">
                    {% if auto_routed_referrals %}
                        {% for referral in auto_routed_referrals %}
                        <div class="queue-item queue-item--auto" role="article" aria-labelledby="referral-{{ referral.id }}-title">
                            <div class="nhsuk-grid-row">
                                <div class="nhsuk-grid-column-two-thirds">
                                    <h4 class="nhsuk-heading-s" id="referral-{{ referral.id }}-title">
                                        <a href="{% url 'referrals:detail' referral.id %}" class="nhsuk-link" 
                                           aria-describedby="referral-{{ referral.id }}-description">
                                            {{ referral.referral_id }}
                                        </a>
                                    </h4>
                                    <p class="nhsuk-body-s" id="referral-{{ referral.id }}-description">
                                        {{ referral.presenting_problem|truncatechars:100 }}
                                    </p>
                                    <p class="nhsuk-body-xs" id="referral-{{ referral.id }}-details">
                                        <strong>Patient:</strong> {{ referral.patient.get_full_name }} |
                                        <strong>Referrer:</strong> {{ referral.referrer.get_full_name }} |
                                        <strong>Created:</strong> {{ referral.created_at|date:"d M Y H:i" }}
                                    </p>
                                </div>
                                <div class="nhsuk-grid-column-one-third">
                                    <div class="action-buttons" role="group" aria-label="Referral status indicators">
                                        <span class="priority-badge priority-badge--{{ referral.priority }}" 
                                              aria-label="Priority: {{ referral.get_priority_display }}">
                                            {{ referral.get_priority_display }}
                                        </span>
                                        <span class="status-badge status-badge--shortlisted" 
                                              aria-label="Status: Auto-routed">
                                            Auto-Routed
                                        </span>
                                    </div>
                                    <div class="action-buttons" role="group" aria-label="Referral actions">
                                        <a href="{% url 'referrals:detail' referral.id %}" 
                                           class="nhsuk-button nhsuk-button--small"
                                           aria-describedby="view-details-help-{{ referral.id }}">
                                            View Details
                                        </a>
                                        <div class="nhsuk-u-visually-hidden" id="view-details-help-{{ referral.id }}">
                                            View full details for referral {{ referral.referral_id }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">✅</div>
                            <p class="nhsuk-body-l">No auto-routed referrals</p>
                            <p class="nhsuk-body">Referrals with high confidence matches will appear here.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Manual Review Queue -->
        <div class="nhsuk-card">
            <div class="nhsuk-card__content">
                <h3 class="nhsuk-card__heading" id="manual-review-heading">Manual Review Queue</h3>
                <p class="nhsuk-card__description">Referrals requiring human intervention for matching.</p>
                
                <div id="manual-review-list" role="region" aria-labelledby="manual-review-heading" aria-live="polite">
                    {% if manual_review_referrals %}
                        {% for referral in manual_review_referrals %}
                        <div class="queue-item queue-item--manual" role="article" aria-labelledby="referral-{{ referral.id }}-title">
                            <div class="nhsuk-grid-row">
                                <div class="nhsuk-grid-column-two-thirds">
                                    <h4 class="nhsuk-heading-s" id="referral-{{ referral.id }}-title">
                                        <a href="{% url 'referrals:detail' referral.id %}" class="nhsuk-link" 
                                           aria-describedby="referral-{{ referral.id }}-description">
                                            {{ referral.referral_id }}
                                        </a>
                                    </h4>
                                    <p class="nhsuk-body-s" id="referral-{{ referral.id }}-description">
                                        {{ referral.presenting_problem|truncatechars:100 }}
                                    </p>
                                    <p class="nhsuk-body-xs" id="referral-{{ referral.id }}-details">
                                        <strong>Patient:</strong> {{ referral.patient.get_full_name }} |
                                        <strong>Referrer:</strong> {{ referral.referrer.get_full_name }} |
                                        <strong>Created:</strong> {{ referral.created_at|date:"d M Y H:i" }}
                                    </p>
                                </div>
                                <div class="nhsuk-grid-column-one-third">
                                    <div class="action-buttons" role="group" aria-label="Referral status indicators">
                                        <span class="priority-badge priority-badge--{{ referral.priority }}" 
                                              aria-label="Priority: {{ referral.get_priority_display }}">
                                            {{ referral.get_priority_display }}
                                        </span>
                                        <span class="status-badge status-badge--matching" 
                                              aria-label="Status: Manual review required">
                                            Manual Review
                                        </span>
                                    </div>
                                    <div class="action-buttons" role="group" aria-label="Referral actions">
                                        <a href="{% url 'matching:find_matches' referral.id %}" 
                                           class="nhsuk-button nhsuk-button--small"
                                           aria-describedby="find-matches-help-{{ referral.id }}">
                                            Find Matches
                                        </a>
                                        <a href="{% url 'referrals:detail' referral.id %}" 
                                           class="nhsuk-button nhsuk-button--secondary nhsuk-button--small"
                                           aria-describedby="view-details-help-{{ referral.id }}">
                                            View Details
                                        </a>
                                        <div class="nhsuk-u-visually-hidden" id="find-matches-help-{{ referral.id }}">
                                            Find matching psychologists for referral {{ referral.referral_id }}
                                        </div>
                                        <div class="nhsuk-u-visually-hidden" id="view-details-help-{{ referral.id }}">
                                            View full details for referral {{ referral.referral_id }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">🔍</div>
                            <p class="nhsuk-body-l">No referrals requiring manual review</p>
                            <p class="nhsuk-body">Referrals with low confidence scores will appear here.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">
        <div class="nhsuk-card">
            <div class="nhsuk-card__content">
                <h3 class="nhsuk-card__heading" id="quick-actions-heading">Quick Actions</h3>
                <div class="action-buttons" role="group" aria-labelledby="quick-actions-heading">
                    <a href="{% url 'referrals:create' %}" class="nhsuk-button" 
                       aria-describedby="create-referral-help">Create New Referral</a>
                    <a href="{% url 'matching:performance_metrics' %}" class="nhsuk-button nhsuk-button--secondary"
                       aria-describedby="performance-metrics-help">View Performance Metrics</a>
                    <a href="{% url 'matching:threshold_config' %}" class="nhsuk-button nhsuk-button--secondary"
                       aria-describedby="configure-thresholds-help">Configure Thresholds</a>
                    <button id="refresh-data" class="nhsuk-button nhsuk-button--secondary"
                            aria-describedby="refresh-data-help">Refresh Data</button>
                    
                    <div class="nhsuk-u-visually-hidden" id="create-referral-help">
                        Create a new referral for a patient
                    </div>
                    <div class="nhsuk-u-visually-hidden" id="performance-metrics-help">
                        View system performance and matching statistics
                    </div>
                    <div class="nhsuk-u-visually-hidden" id="configure-thresholds-help">
                        Configure matching thresholds for different user types
                    </div>
                    <div class="nhsuk-u-visually-hidden" id="refresh-data-help">
                        Refresh the dashboard data to show latest information
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Refresh data functionality
    const refreshButton = document.getElementById('refresh-data');
    if (refreshButton) {
        refreshButton.addEventListener('click', function() {
            // Add loading state
            refreshButton.disabled = true;
            refreshButton.textContent = 'Refreshing...';
            refreshButton.setAttribute('aria-label', 'Refreshing dashboard data, please wait');
            
            // Announce refresh to screen readers
            const statusAnnouncements = document.getElementById('status-announcements');
            if (statusAnnouncements) {
                statusAnnouncements.textContent = 'Refreshing dashboard data, please wait';
            }
            
            // Simulate refresh (in real implementation, this would make an API call)
            setTimeout(() => {
                location.reload();
            }, 1000);
        });
    }
    
    // Auto-refresh every 30 seconds
    setInterval(function() {
        // Only refresh if no user interaction in the last 5 minutes
        if (document.visibilityState === 'visible') {
            location.reload();
        }
    }, 30000);
    
    // Filter form submission
    const filterForm = document.querySelector('.filter-row');
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            // Add loading state
            const submitButton = filterForm.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.textContent = 'Loading...';
                submitButton.disabled = true;
                submitButton.setAttribute('aria-label', 'Filtering referrals, please wait');
            }
            
            // Announce filtering to screen readers
            const statusAnnouncements = document.getElementById('status-announcements');
            if (statusAnnouncements) {
                statusAnnouncements.textContent = 'Filtering referrals, please wait';
            }
        });
    }
});
</script>
{% endblock %}
