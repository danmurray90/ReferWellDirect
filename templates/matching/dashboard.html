{% extends 'base.html' %}
{% load static %}

{% block title %}Matching Dashboard - ReferWell Direct{% endblock %}

{% block page_header %}
<div class="main-content__header">
    <div class="container">
        <h1 class="main-content__title">Matching Dashboard</h1>
        <p class="main-content__subtitle">Monitor and manage the intelligent referral matching system</p>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .queue-item {
        border: 1px solid var(--color-gray-200);
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        margin-bottom: var(--space-4);
        background: white;
        transition: all var(--transition-normal);
        position: relative;
        overflow: hidden;
    }
    
    .queue-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--color-gray-300);
    }
    
    .queue-item:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }
    
    .queue-item--high-touch::before {
        background: var(--color-error-gradient);
    }
    
    .queue-item--auto::before {
        background: var(--color-success-gradient);
    }
    
    .queue-item--manual::before {
        background: var(--color-warning-gradient);
    }
    
    .priority-badge {
        display: inline-flex;
        align-items: center;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-semibold);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .priority-badge--urgent {
        background: var(--color-error);
        color: white;
    }
    
    .priority-badge--high {
        background: var(--color-warning);
        color: var(--color-gray-800);
    }
    
    .priority-badge--medium {
        background: var(--color-success);
        color: white;
    }
    
    .priority-badge--low {
        background: var(--color-gray-500);
        color: white;
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-semibold);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .status-badge--high-touch {
        background: var(--color-error);
        color: white;
    }
    
    .status-badge--shortlisted {
        background: var(--color-success);
        color: white;
    }
    
    .status-badge--matching {
        background: var(--color-warning);
        color: var(--color-gray-800);
    }
    
    .status-badge--submitted {
        background: var(--color-gray-500);
        color: white;
    }
    
    .action-buttons {
        display: flex;
        gap: var(--space-3);
        margin-top: var(--space-4);
        flex-wrap: wrap;
    }
    
    .empty-state {
        text-align: center;
        padding: var(--space-16) var(--space-4);
        color: var(--color-gray-500);
    }
    
    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: var(--space-6);
        opacity: 0.6;
    }
    
    .filter-controls {
        background: var(--color-gray-50);
        padding: var(--space-6);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-8);
        border: 1px solid var(--color-gray-200);
    }
    
    .filter-row {
        display: flex;
        gap: var(--space-4);
        align-items: end;
        flex-wrap: wrap;
    }
    
    .filter-group {
        flex: 1;
        min-width: 200px;
    }
    
    .filter-group label {
        display: block;
        font-weight: var(--font-weight-medium);
        color: var(--color-gray-700);
        margin-bottom: var(--space-2);
        font-size: var(--font-size-sm);
    }
    
    .filter-group select {
        width: 100%;
        padding: var(--space-3);
        border: 1px solid var(--color-gray-300);
        border-radius: var(--radius-md);
        background: white;
        font-size: var(--font-size-base);
        transition: border-color var(--transition-fast);
    }
    
    .filter-group select:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(0, 94, 184, 0.1);
    }
    
    @media (max-width: 768px) {
        .filter-row {
            flex-direction: column;
            align-items: stretch;
        }
        
        .filter-group {
            min-width: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Screen reader announcement for dynamic content -->
    <div class="nhsuk-u-visually-hidden" aria-live="polite" id="status-announcements"></div>

    <!-- Statistics Overview -->
    <div class="grid grid-cols-4 mb-8">
        <div class="stat-card" role="group" aria-labelledby="total-referrals-label">
            <p class="stat-card__value" id="total-referrals" aria-label="{{ total_referrals|default:0 }} total referrals">{{ total_referrals|default:0 }}</p>
            <p class="stat-card__label" id="total-referrals-label">Total Referrals</p>
            <p class="stat-card__description">All time referrals processed</p>
        </div>
        <div class="stat-card" role="group" aria-labelledby="auto-routed-label">
            <p class="stat-card__value" id="auto-routed" aria-label="{{ auto_routed|default:0 }} auto-routed referrals">{{ auto_routed|default:0 }}</p>
            <p class="stat-card__label" id="auto-routed-label">Auto-Routed</p>
            <p class="stat-card__description">Automatically processed</p>
        </div>
        <div class="stat-card" role="group" aria-labelledby="high-touch-queue-label">
            <p class="stat-card__value" id="high-touch-queue" aria-label="{{ high_touch_queue|default:0 }} referrals in high-touch queue">{{ high_touch_queue|default:0 }}</p>
            <p class="stat-card__label" id="high-touch-queue-label">High-Touch Queue</p>
            <p class="stat-card__description">Requiring manual review</p>
        </div>
        <div class="stat-card" role="group" aria-labelledby="manual-review-label">
            <p class="stat-card__value" id="manual-review" aria-label="{{ manual_review|default:0 }} referrals requiring manual review">{{ manual_review|default:0 }}</p>
            <p class="stat-card__label" id="manual-review-label">Manual Review</p>
            <p class="stat-card__description">Awaiting specialist input</p>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="filter-controls" role="region" aria-labelledby="filter-heading">
        <h3 class="card__title" id="filter-heading">Filter Referrals</h3>
        <form method="get" class="filter-row" role="search" aria-label="Filter referrals">
            <div class="filter-group">
                <label for="status-filter">Status</label>
                <select id="status-filter" name="status" aria-describedby="status-help">
                    <option value="">All Statuses</option>
                    <option value="submitted">Submitted</option>
                    <option value="matching">Matching</option>
                    <option value="high_touch_queue">High-Touch Queue</option>
                    <option value="shortlisted">Shortlisted</option>
                </select>
                <div class="nhsuk-hint" id="status-help">Filter referrals by their current status</div>
            </div>
            <div class="filter-group">
                <label for="priority-filter">Priority</label>
                <select id="priority-filter" name="priority" aria-describedby="priority-help">
                    <option value="">All Priorities</option>
                    <option value="urgent">Urgent</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
                <div class="nhsuk-hint" id="priority-help">Filter referrals by priority level</div>
            </div>
            <div class="filter-group">
                <label for="service-type-filter">Service Type</label>
                <select id="service-type-filter" name="service_type" aria-describedby="service-type-help">
                    <option value="">All Service Types</option>
                    <option value="nhs">NHS</option>
                    <option value="private">Private</option>
                    <option value="mixed">Mixed</option>
                </select>
                <div class="nhsuk-hint" id="service-type-help">Filter referrals by service type</div>
            </div>
            <div class="filter-group">
                <button class="btn btn--primary" type="submit" aria-describedby="apply-help">Apply Filters</button>
                <a href="{% url 'matching:dashboard' %}" class="btn btn--secondary" aria-describedby="clear-help">Clear</a>
                <div class="nhsuk-hint" id="apply-help">Apply the selected filters to the referral list</div>
                <div class="nhsuk-hint" id="clear-help">Clear all filters and show all referrals</div>
            </div>
        </form>
    </div>

    <!-- Referral Queues -->
    <h2 style="font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); color: var(--color-gray-800); margin: var(--space-8) 0 var(--space-6) 0;">Referral Queues</h2>
    
    <!-- High-Touch Queue -->
    <div class="card card--elevated mb-8">
        <div class="card__header">
            <h3 class="card__title" id="high-touch-queue-heading">High-Touch Queue</h3>
            <p class="card__subtitle">Referrals requiring manual review and expert matching</p>
        </div>
        <div class="card__content">
                
            <div id="high-touch-queue-list" role="region" aria-labelledby="high-touch-queue-heading" aria-live="polite">
                {% if high_touch_referrals %}
                    {% for referral in high_touch_referrals %}
                    <div class="queue-item queue-item--high-touch" role="article" aria-labelledby="referral-{{ referral.id }}-title">
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-6); align-items: start;">
                            <div>
                                <h4 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); color: var(--color-gray-800); margin: 0 0 var(--space-2) 0;" id="referral-{{ referral.id }}-title">
                                    <a href="{% url 'referrals:detail' referral.id %}" style="color: var(--color-primary); text-decoration: none;" 
                                       aria-describedby="referral-{{ referral.id }}-description">
                                        {{ referral.referral_id }}
                                    </a>
                                </h4>
                                <p style="color: var(--color-gray-600); margin: 0 0 var(--space-3) 0; line-height: var(--line-height-relaxed);" id="referral-{{ referral.id }}-description">
                                    {{ referral.presenting_problem|truncatechars:100 }}
                                </p>
                                <p style="font-size: var(--font-size-sm); color: var(--color-gray-500); margin: 0;" id="referral-{{ referral.id }}-details">
                                    <strong>Patient:</strong> {{ referral.patient.get_full_name }} |
                                    <strong>Referrer:</strong> {{ referral.referrer.get_full_name }} |
                                    <strong>Created:</strong> {{ referral.created_at|date:"d M Y H:i" }}
                                </p>
                            </div>
                            <div>
                                <div style="display: flex; gap: var(--space-2); margin-bottom: var(--space-4);" role="group" aria-label="Referral status indicators">
                                    <span class="priority-badge priority-badge--{{ referral.priority }}" 
                                          aria-label="Priority: {{ referral.get_priority_display }}">
                                        {{ referral.get_priority_display }}
                                    </span>
                                    <span class="status-badge status-badge--high-touch" 
                                          aria-label="Status: High-Touch queue">
                                        High-Touch
                                    </span>
                                </div>
                                <div class="action-buttons" role="group" aria-label="Referral actions">
                                    <a href="{% url 'matching:find_matches' referral.id %}" 
                                       class="btn btn--primary btn--sm"
                                       aria-describedby="find-matches-help-{{ referral.id }}">
                                        Find Matches
                                    </a>
                                    <a href="{% url 'referrals:detail' referral.id %}" 
                                       class="btn btn--secondary btn--sm"
                                       aria-describedby="view-details-help-{{ referral.id }}">
                                        View Details
                                    </a>
                                    <div class="nhsuk-u-visually-hidden" id="find-matches-help-{{ referral.id }}">
                                        Find matching psychologists for referral {{ referral.referral_id }}
                                    </div>
                                    <div class="nhsuk-u-visually-hidden" id="view-details-help-{{ referral.id }}">
                                        View full details for referral {{ referral.referral_id }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <p style="font-size: var(--font-size-lg); font-weight: var(--font-weight-medium); margin: 0 0 var(--space-2) 0;">No referrals in high-touch queue</p>
                        <p style="margin: 0;">Referrals requiring manual review will appear here.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

        <!-- Auto-Routed Referrals -->
        <div class="nhsuk-card">
            <div class="nhsuk-card__content">
                <h3 class="nhsuk-card__heading" id="auto-routed-heading">Auto-Routed Referrals</h3>
                <p class="nhsuk-card__description">Referrals automatically matched with high confidence scores.</p>
                
                <div id="auto-routed-list" role="region" aria-labelledby="auto-routed-heading" aria-live="polite">
                    {% if auto_routed_referrals %}
                        {% for referral in auto_routed_referrals %}
                        <div class="queue-item queue-item--auto" role="article" aria-labelledby="referral-{{ referral.id }}-title">
                            <div class="nhsuk-grid-row">
                                <div class="nhsuk-grid-column-two-thirds">
                                    <h4 class="nhsuk-heading-s" id="referral-{{ referral.id }}-title">
                                        <a href="{% url 'referrals:detail' referral.id %}" class="nhsuk-link" 
                                           aria-describedby="referral-{{ referral.id }}-description">
                                            {{ referral.referral_id }}
                                        </a>
                                    </h4>
                                    <p class="nhsuk-body-s" id="referral-{{ referral.id }}-description">
                                        {{ referral.presenting_problem|truncatechars:100 }}
                                    </p>
                                    <p class="nhsuk-body-xs" id="referral-{{ referral.id }}-details">
                                        <strong>Patient:</strong> {{ referral.patient.get_full_name }} |
                                        <strong>Referrer:</strong> {{ referral.referrer.get_full_name }} |
                                        <strong>Created:</strong> {{ referral.created_at|date:"d M Y H:i" }}
                                    </p>
                                </div>
                                <div class="nhsuk-grid-column-one-third">
                                    <div class="action-buttons" role="group" aria-label="Referral status indicators">
                                        <span class="priority-badge priority-badge--{{ referral.priority }}" 
                                              aria-label="Priority: {{ referral.get_priority_display }}">
                                            {{ referral.get_priority_display }}
                                        </span>
                                        <span class="status-badge status-badge--shortlisted" 
                                              aria-label="Status: Auto-routed">
                                            Auto-Routed
                                        </span>
                                    </div>
                                    <div class="action-buttons" role="group" aria-label="Referral actions">
                                        <a href="{% url 'referrals:detail' referral.id %}" 
                                           class="nhsuk-button nhsuk-button--small"
                                           aria-describedby="view-details-help-{{ referral.id }}">
                                            View Details
                                        </a>
                                        <div class="nhsuk-u-visually-hidden" id="view-details-help-{{ referral.id }}">
                                            View full details for referral {{ referral.referral_id }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">✅</div>
                            <p class="nhsuk-body-l">No auto-routed referrals</p>
                            <p class="nhsuk-body">Referrals with high confidence matches will appear here.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Manual Review Queue -->
        <div class="nhsuk-card">
            <div class="nhsuk-card__content">
                <h3 class="nhsuk-card__heading" id="manual-review-heading">Manual Review Queue</h3>
                <p class="nhsuk-card__description">Referrals requiring human intervention for matching.</p>
                
                <div id="manual-review-list" role="region" aria-labelledby="manual-review-heading" aria-live="polite">
                    {% if manual_review_referrals %}
                        {% for referral in manual_review_referrals %}
                        <div class="queue-item queue-item--manual" role="article" aria-labelledby="referral-{{ referral.id }}-title">
                            <div class="nhsuk-grid-row">
                                <div class="nhsuk-grid-column-two-thirds">
                                    <h4 class="nhsuk-heading-s" id="referral-{{ referral.id }}-title">
                                        <a href="{% url 'referrals:detail' referral.id %}" class="nhsuk-link" 
                                           aria-describedby="referral-{{ referral.id }}-description">
                                            {{ referral.referral_id }}
                                        </a>
                                    </h4>
                                    <p class="nhsuk-body-s" id="referral-{{ referral.id }}-description">
                                        {{ referral.presenting_problem|truncatechars:100 }}
                                    </p>
                                    <p class="nhsuk-body-xs" id="referral-{{ referral.id }}-details">
                                        <strong>Patient:</strong> {{ referral.patient.get_full_name }} |
                                        <strong>Referrer:</strong> {{ referral.referrer.get_full_name }} |
                                        <strong>Created:</strong> {{ referral.created_at|date:"d M Y H:i" }}
                                    </p>
                                </div>
                                <div class="nhsuk-grid-column-one-third">
                                    <div class="action-buttons" role="group" aria-label="Referral status indicators">
                                        <span class="priority-badge priority-badge--{{ referral.priority }}" 
                                              aria-label="Priority: {{ referral.get_priority_display }}">
                                            {{ referral.get_priority_display }}
                                        </span>
                                        <span class="status-badge status-badge--matching" 
                                              aria-label="Status: Manual review required">
                                            Manual Review
                                        </span>
                                    </div>
                                    <div class="action-buttons" role="group" aria-label="Referral actions">
                                        <a href="{% url 'matching:find_matches' referral.id %}" 
                                           class="nhsuk-button nhsuk-button--small"
                                           aria-describedby="find-matches-help-{{ referral.id }}">
                                            Find Matches
                                        </a>
                                        <a href="{% url 'referrals:detail' referral.id %}" 
                                           class="nhsuk-button nhsuk-button--secondary nhsuk-button--small"
                                           aria-describedby="view-details-help-{{ referral.id }}">
                                            View Details
                                        </a>
                                        <div class="nhsuk-u-visually-hidden" id="find-matches-help-{{ referral.id }}">
                                            Find matching psychologists for referral {{ referral.referral_id }}
                                        </div>
                                        <div class="nhsuk-u-visually-hidden" id="view-details-help-{{ referral.id }}">
                                            View full details for referral {{ referral.referral_id }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">🔍</div>
                            <p class="nhsuk-body-l">No referrals requiring manual review</p>
                            <p class="nhsuk-body">Referrals with low confidence scores will appear here.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">
        <div class="nhsuk-card">
            <div class="nhsuk-card__content">
                <h3 class="nhsuk-card__heading" id="quick-actions-heading">Quick Actions</h3>
                <div class="action-buttons" role="group" aria-labelledby="quick-actions-heading">
                    <a href="{% url 'referrals:create' %}" class="nhsuk-button" 
                       aria-describedby="create-referral-help">Create New Referral</a>
                    <a href="{% url 'matching:performance_metrics' %}" class="nhsuk-button nhsuk-button--secondary"
                       aria-describedby="performance-metrics-help">View Performance Metrics</a>
                    <a href="{% url 'matching:threshold_config' %}" class="nhsuk-button nhsuk-button--secondary"
                       aria-describedby="configure-thresholds-help">Configure Thresholds</a>
                    <button id="refresh-data" class="nhsuk-button nhsuk-button--secondary"
                            aria-describedby="refresh-data-help">Refresh Data</button>
                    
                    <div class="nhsuk-u-visually-hidden" id="create-referral-help">
                        Create a new referral for a patient
                    </div>
                    <div class="nhsuk-u-visually-hidden" id="performance-metrics-help">
                        View system performance and matching statistics
                    </div>
                    <div class="nhsuk-u-visually-hidden" id="configure-thresholds-help">
                        Configure matching thresholds for different user types
                    </div>
                    <div class="nhsuk-u-visually-hidden" id="refresh-data-help">
                        Refresh the dashboard data to show latest information
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Refresh data functionality
    const refreshButton = document.getElementById('refresh-data');
    if (refreshButton) {
        refreshButton.addEventListener('click', function() {
            // Add loading state
            refreshButton.disabled = true;
            refreshButton.textContent = 'Refreshing...';
            refreshButton.setAttribute('aria-label', 'Refreshing dashboard data, please wait');
            
            // Announce refresh to screen readers
            const statusAnnouncements = document.getElementById('status-announcements');
            if (statusAnnouncements) {
                statusAnnouncements.textContent = 'Refreshing dashboard data, please wait';
            }
            
            // Simulate refresh (in real implementation, this would make an API call)
            setTimeout(() => {
                location.reload();
            }, 1000);
        });
    }
    
    // Auto-refresh every 30 seconds
    setInterval(function() {
        // Only refresh if no user interaction in the last 5 minutes
        if (document.visibilityState === 'visible') {
            location.reload();
        }
    }, 30000);
    
    // Filter form submission
    const filterForm = document.querySelector('.filter-row');
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            // Add loading state
            const submitButton = filterForm.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.textContent = 'Loading...';
                submitButton.disabled = true;
                submitButton.setAttribute('aria-label', 'Filtering referrals, please wait');
            }
            
            // Announce filtering to screen readers
            const statusAnnouncements = document.getElementById('status-announcements');
            if (statusAnnouncements) {
                statusAnnouncements.textContent = 'Filtering referrals, please wait';
            }
        });
    }
});
</script>
{% endblock %}
